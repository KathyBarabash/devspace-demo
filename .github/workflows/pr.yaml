name: pr
on:
  pull_request:
    branches:
    - master
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v2
      with:
        submodules: recursive
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v1
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1
    - name: Login to DockerHub
      uses: docker/login-action@v1 
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - name: Build and push container image
      uses: docker/build-push-action@v2
      with:
        push: true
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/devops-toolkit:pr-${{ github.event.pull_request.number }}
    - name: Setup Kube config
      uses: azure/k8s-set-context@v1
      with:
        method: kubeconfig
        kubeconfig: ${{ secrets.KUBE_CONFIG }}
    - name: Deploy preview
      run: |
        # Install vCluster
        curl -s -L "https://github.com/loft-sh/vcluster/releases/latest" | sed -nE 's!.*"([^"]*vcluster-linux-amd64)".*!https://github.com\1!p' | xargs -n 1 curl -L -o vcluster && chmod +x vcluster;
        sudo mv vcluster /usr/local/bin;

        # Create a cluster
        vcluster create devops-toolkit-pr-${{ github.event.pull_request.number }} --namespace prs --expose 
        vcluster connect devops-toolkit-pr-${{ github.event.pull_request.number }} --namespace prs

        cat "111"
        cat kubeconfig.yaml

        export KUBECONFIG=./kubeconfig.yaml
        cd kustomize/overlays/preview
        kustomize edit set image vfarcic/devops-toolkit=${{ secrets.DOCKERHUB_USERNAME }}/devops-toolkit:pr-${{ github.event.pull_request.number }}
        kustomize build | kubectl apply --filename -
        kubectl rollout status deployment github-actions-demo
      # uses: wahyd4/kubectl-helm-action@master
      # env:
      #   KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
      # with:
      #   args: kubectl get namespaces
    # - name: Create a cluster
    #   uses: addnab/docker-run-action@v3
    #   with:
    #     image: efrecon/vcluster:v0.3.0
    #     run: |
    #       vcluster create devops-toolkit-pr-${{ github.event.pull_request.number }} --namespace prs
    # - name: Deploy the app
    #   run: |
    #     cd kustomize/overlays/preview
    #     kustomize edit set image ${{ secrets.DOCKERHUB_USERNAME }}/github-actions-demo=${{ secrets.DOCKERHUB_USERNAME }}/github-actions-demo:pr-${{ github.event.pull_request.number }}
    #     kustomize build | kubectl apply --filename -
    #     kubectl rollout status deployment github-actions-demo
    # - name: Test
    #   run: |
    #     kubectl run test --image alpine -i --restart Never -- sh -c "apk add --update curl && curl github-actions-demo"
